<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Pedidos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #333;
            --accent-color: #007bff;
            --success-color: #28a745;
            --edit-color: #ffc107; /* Amarelo para edição */
            --background-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color-light: #6c757d;
            --border-color: #dee2e6;
            --status-pendente-bg: #fff3cd; --status-pendente-text: #856404;
            --status-atendido-bg: #d4edda; --status-atendido-text: #155724;
            --status-parcial-bg: #d1ecf1;  --status-parcial-text: #0c5460;
            --status-cancelado-bg: #f8d7da; --status-cancelado-text: #721c24;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: #333; margin: 0; padding: 20px; }
        .page-container { max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; gap: 25px; }
        .card { background-color: var(--card-bg-color); padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .actions-cell { display: flex; align-items: center; gap: 12px; }
        .actions-cell i { cursor: pointer; font-size: 24px; }
        .actions-cell .view-btn { color: var(--accent-color); }
        .actions-cell .dar-baixa-btn { color: var(--success-color); }
        .actions-cell .edit-baixa-btn { color: var(--edit-color); }
        .actions-cell .dar-baixa-btn.disabled { color: #adb5bd; cursor: not-allowed; }
        .status-badge { padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; text-align: center; }
        /* Outros estilos sem alteração */
        .page-header { text-align: center; }
        .page-header h1 { font-weight: 500; }
        .page-header p { color: var(--text-color-light); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background-color: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .kpi-title { font-size: 1em; color: var(--text-color-light); margin: 0 0 10px 0; }
        .kpi-value { font-size: 2.5em; font-weight: 700; color: var(--accent-color); }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center; }
        .filters input, .filters select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Roboto', sans-serif; flex: 1; }
        .filters .search-bar { flex: 2; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: 500; }
        .status-Pendente { background-color: var(--status-pendente-bg); color: var(--status-pendente-text); }
        .status-Atendido { background-color: var(--status-atendido-bg); color: var(--status-atendido-text); }
        .status-Atendido\.Parcialmente { background-color: var(--status-parcial-bg); color: var(--status-parcial-text); }
        .status-Cancelado { background-color: var(--status-cancelado-bg); color: var(--status-cancelado-text); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-container { background: #fff; border-radius: 8px; width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.2em; }
        .modal-close-btn { background: none; border: none; cursor: pointer; font-size: 24px; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        .btn { border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .detail-item strong { display: block; color: var(--text-color-light); font-size: 0.9em; margin-bottom: 5px; }
        .input-qtd-atendida { width: 70px; text-align: center; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <h1>Histórico de Pedidos</h1>
            <p>Consulte e analise todas as fichas de expedição registradas no sistema.</p>
        </header>

        <div class="card">
            <div class="kpi-grid">
                 <div class="kpi-card"><p class="kpi-title">Total de Pedidos</p><h3 class="kpi-value" id="kpi-total">--</h3></div>
                 <div class="kpi-card"><p class="kpi-title">Pedidos Pendentes</p><h3 class="kpi-value" id="kpi-pendentes">--</h3></div>
                 <div class="kpi-card"><p class="kpi-title">Pedidos Atendidos</p><h3 class="kpi-value" id="kpi-atendidos">--</h3></div>
                 <div class="kpi-card"><p class="kpi-title">Pedidos Cancelados</p><h3 class="kpi-value" id="kpi-cancelados">--</h3></div>
            </div>
            <div class="filters">
                <input type="text" id="search-filter" class="search-bar" placeholder="Buscar por Nº do pedido, setor ou requisitante...">
                <select id="status-filter"><option value="">Todos os Status</option><option value="Pendente">Pendente</option><option value="Atendido Parcialmente">Atendido Parcialmente</option><option value="Atendido">Atendido</option><option value="Cancelado">Cancelado</option></select>
                <input type="date" id="date-start-filter">
                <input type="date" id="date-end-filter">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Nº Pedido</th>
                        <th>Data</th>
                        <th>Setor Solicitante</th>
                        <th>Requisitante</th>
                        <th style="text-align: center;">Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="pedidos-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="details-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modal-title">Detalhes do Pedido</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content"></div>
            <div class="modal-footer" id="modal-footer-content"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://bixobvseaocmhljckskl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpeG9idnNlYW9jbWhsamNrc2tsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTgyNjcsImV4cCI6MjA3MDU5NDI2N30.SjChWwpw3zYPa_lJ5Z4axpDExXHSHdq0_pntpfES2jo';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tableBody = document.getElementById('pedidos-table-body');
    const modal = document.getElementById('details-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body-content');
    const modalFooter = document.getElementById('modal-footer-content');
    let currentPedidoData = null;
    let allPedidos = [];

    async function carregarPedidos() {
        tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Carregando...</td></tr>`;
        const { data, error } = await supabaseClient
            .from('historico_pedidos')
            .select(`id, created_at, requisitante_nome, status, setores ( nome_setor )`)
            .order('id', { ascending: false });

        if (error) {
            console.error("Erro ao carregar pedidos:", error);
            return;
        }
        allPedidos = data;
        renderizarTabelaEIndicadores(allPedidos);
    }

    function renderizarTabelaEIndicadores(pedidos) {
        tableBody.innerHTML = '';
        pedidos.forEach(p => {
            const tr = document.createElement('tr');
            const dataFormatada = new Date(p.created_at).toLocaleDateString('pt-BR');
            const statusClass = `status-${p.status.replace(/\s/g, '')}`;
            
            let acoesHtml = `<i class="material-icons view-btn" data-id="${p.id}" title="Ver Detalhes">visibility</i>`;
            
            if (p.status === 'Pendente') {
                acoesHtml += `<i class="material-icons dar-baixa-btn" data-id="${p.id}" title="Dar Baixa no Pedido">local_shipping</i>`;
            } else if (p.status === 'Atendido' || p.status === 'Atendido Parcialmente') {
                acoesHtml += `<i class="material-icons dar-baixa-btn disabled" title="Pedido já atendido">local_shipping</i>`;
                acoesHtml += `<i class="material-icons edit-baixa-btn" data-id="${p.id}" title="Editar Baixa">edit</i>`;
            }
            
            tr.innerHTML = `
                <td>#${p.id}</td>
                <td>${dataFormatada}</td>
                <td>${p.setores ? p.setores.nome_setor : '-'}</td>
                <td>${p.requisitante_nome || '-'}</td>
                <td style="text-align: center;"><span class="status-badge ${statusClass}">${p.status}</span></td>
                <td class="actions-cell">${acoesHtml}</td>
            `;
            tableBody.appendChild(tr);
        });

        document.getElementById('kpi-total').textContent = allPedidos.length;
        document.getElementById('kpi-pendentes').textContent = allPedidos.filter(p => p.status === 'Pendente').length;
        document.getElementById('kpi-atendidos').textContent = allPedidos.filter(p => p.status === 'Atendido' || p.status === 'Atendido Parcialmente').length;
        document.getElementById('kpi-cancelados').textContent = allPedidos.filter(p => p.status === 'Cancelado').length;
    }

    function renderizarFichaNoModal(data, mode = 'view') {
        currentPedidoData = data;
        let title = '';
        if (mode === 'view') {
            title = `Resumo do Pedido #${data.id}`;
        } else if (data.status === 'Pendente') {
            title = `Dar Baixa no Pedido #${data.id}`;
        } else {
            title = `Editar Baixa do Pedido #${data.id}`;
        }
        modalTitle.textContent = title;
        
        const isBaixaMode = mode === 'baixa';
        let tableHeaders = '<th>Item</th><th>Produto</th><th style="text-align: center;">Qtd. Solicitada</th>';
        if (isBaixaMode) {
            tableHeaders += '<th style="text-align: center;">Qtd. Atendida</th>';
        }

        let itemsHtml = (data.historico_pedido_itens || []).map((item, index) => {
            let rowHtml = `
                <td>${index + 1}</td>
                <td>${item.produtos?.descricao || 'Produto não encontrado'}</td>
                <td style="text-align: center;">${item.qtd_solicitada}</td>
            `;
            if (isBaixaMode) {
                const qtdAtendida = item.qtd_atendida || 0;
                rowHtml += `<td style="text-align: center;">
                                <input type="number" class="input-qtd-atendida" 
                                       data-item-id="${item.id}" 
                                       value="${qtdAtendida}" 
                                       min="0" max="${item.qtd_solicitada}">
                            </td>`;
            }
            return `<tr>${rowHtml}</tr>`;
        }).join('');

        modalBody.innerHTML = `
            <div class="detail-grid">
                <div class="detail-item"><strong>Data do Pedido:</strong> <span>${new Date(data.created_at).toLocaleString('pt-BR')}</span></div>
                <div class="detail-item"><strong>Setor Solicitante:</strong> <span>${data.setores.nome_setor}</span></div>
                <div class="detail-item"><strong>Requisitante:</strong> <span>${data.requisitante_nome || '-'}</span></div>
                <div class="detail-item"><strong>Status:</strong> <span>${data.status}</span></div>
            </div>
            <h4>Itens Solicitados</h4>
            <table>
                <thead><tr>${tableHeaders}</tr></thead>
                <tbody>${itemsHtml || `<tr><td colspan="${isBaixaMode ? 4 : 3}" style="text-align: center;">Nenhum item.</td></tr>`}</tbody>
            </table>
        `;

        if (isBaixaMode) {
            modalFooter.innerHTML = `<button type="button" class="btn btn-secondary modal-close-btn">Cancelar</button>
                                     <button type="button" class="btn btn-success" id="confirmar-saida-btn">Confirmar</button>`;
            document.getElementById('confirmar-saida-btn').addEventListener('click', processarBaixa);
        } else {
            modalFooter.innerHTML = `<button type="button" class="btn btn-secondary modal-close-btn">Fechar</button>`;
        }
    }
    
    async function abrirModal(pedidoId, mode) {
        modalBody.innerHTML = '<p>Carregando...</p>';
        modal.style.display = 'flex';
        const { data, error } = await supabaseClient
            .from('historico_pedidos')
            .select(`*, setores(nome_setor), historico_pedido_itens!ficha_id(*, produtos(descricao))`)
            .eq('id', pedidoId)
            .single();

        if (error) {
            modalBody.innerHTML = '<p style="color:red;">Erro ao carregar detalhes.</p>';
            console.error(error);
            return;
        }
        renderizarFichaNoModal(data, mode);
    }

    async function processarBaixa() {
        const btn = document.getElementById('confirmar-saida-btn');
        btn.disabled = true;
        btn.textContent = 'Processando...';

        const inputs = modalBody.querySelectorAll('.input-qtd-atendida');
        const itensPayload = Array.from(inputs).map(input => ({
            item_id: parseInt(input.dataset.itemId),
            nova_qtd_atendida: parseInt(input.value)
        }));

        const isEditing = currentPedidoData.status !== 'Pendente';
        const rpc_function = isEditing ? 'editar_baixa_pedido' : 'realizar_baixa_pedido';

        try {
            const { error } = await supabaseClient.rpc(rpc_function, {
                p_pedido_id: currentPedidoData.id,
                p_itens: itensPayload
            });

            if (error) throw error;

            alert('Operação realizada com sucesso!');
            modal.style.display = 'none';
            carregarPedidos();

        } catch (error) {
            alert('Erro ao processar a baixa: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Confirmar';
        }
    }

    tableBody.addEventListener('click', (event) => {
        const viewBtn = event.target.closest('.view-btn');
        if (viewBtn) return abrirModal(viewBtn.dataset.id, 'view');
        
        const baixaBtn = event.target.closest('.dar-baixa-btn:not(.disabled)');
        if (baixaBtn) return abrirModal(baixaBtn.dataset.id, 'baixa');

        const editBtn = event.target.closest('.edit-baixa-btn');
        if (editBtn) return abrirModal(editBtn.dataset.id, 'baixa');
    });

    modal.addEventListener('click', (event) => {
         if (event.target.classList.contains('modal-close-btn') || event.target.matches('.modal-overlay')) {
             modal.style.display = 'none';
         }
    });
    
    carregarPedidos();
});
</script>
</body>
</html>